{% extends "layout_2_col.html" %}
{% load staticfiles %}
{% load currency_filters %}
{% load thumbnail %}
{% load product_tags %}
{% load i18n %}

{% block extrastyles %}
    <link rel="stylesheet" type="text/css" href="{% static "oscar/css/results.css" %}" />
{% endblock extrastyles %}

{% block column_left %}
    {% include 'search/partials/search_filter.html' with name=data.name items=data.results %}
{% endblock %}

{% block headertext %}
    {% trans "Results"|upper %}
{% endblock %}

{% block content %}
    <form method="get" action="." class="form-horizontal">
        {# Render other search params as hidden inputs #}
        {% for value in selected_facets %}
            <input type="hidden" name="selected_facets" value="{{ value }}" />
        {% endfor %}
        <input type="hidden" name="q" value="{{ search_form.q.value }}" />

        {% if paginator.count %}
            {% if paginator.num_pages > 1 %}
                {% blocktrans with start=page.start_index end=page.end_index num_results=paginator.count %}
                    Found <strong>{{ num_results }}</strong> results, showing <strong>{{ start }}</strong> to <strong>{{ end }}</strong>.
                {% endblocktrans %}
            {% else %}
                {% blocktrans count num_results=paginator.count %}
                    Found <strong>{{ num_results }}</strong> result.
                {% plural %}
                    Found <strong>{{ num_results }}</strong> results.
                {% endblocktrans %}
            {% endif %}
            <!--
            <div class="pull-right">
                {# {% include "partials/form_field.html" with field=search_form.sort_by %} #}
            </div>
            -->
        {% else %}
            <p>
                {% trans "Found" %} <strong>0</strong> {% trans "results" %}.
                {% if suggestion %}
                    {% url 'search:search' as search_url %}
                    {% blocktrans %}
                        Did you mean <a href="{{ search_url }}?q={{ suggestion }}">"{{ suggestion }}"</a>?
                    {% endblocktrans %}
                {% endif %}
            </p>
        {% endif %}
    </form>

    {% if page.object_list %}
        <section>
            <div>
                <ol class="row">
                    {% for result in page.object_list %}
                        <li class="col-xs-6 col-sm-4 col-md-4 col-lg-4">{% render_product result.object %}</li>
                    {% endfor %}
                </ol>
                {% include "partials/pagination.html" with page_obj=page %}
            </div>
        </section>
    {% endif %}
    {% include "partials/customer_service.html" %}
{% endblock %}

{% block onbodyload %}
    {{ block.super }}
    oscar.search.init();
{% endblock %}

{% block extrascripts %}
    <script>
        var results = [];
        var index = 0;
        var params = '{{url_args}}'.split(',');
        var categories = jQuery.parseJSON('{{categories_json|safe}}');

        categories = categories['trees'];

        
        /*Initial form values*/
        var append_value = '<div class="form-group text-center"><select class="form-control" name="var" id="var"><option value="0">-- {% trans "Select Category" %} --</option>';
        
        $.each(categories, function(key, value){
            init_search_form(value, '#categories_form');
        });
        
        append_value += '</select></div>';
        $('#categories_form').prepend(
            append_value
        );

        /*Function to initialize the form*/
        function init_search_form(value){
            append_value += '<option value="category:'+ value['full_name'] + '"';

            if($.inArray("category:" + escapeHtml(value['full_name'].toString()), params) >= 0){
                append_value +='selected >' + value['name'] + '</option>';
            }
            else
            {
                append_value +='>' + value['name'] + '</option>';
            }
        }

        /*Searchs for the selected values in the tree*/
        function search(dictionary, values){
            $.each(dictionary, function(key, value){
                if (values[index] !== undefined) {
                    
                    if (unescapeHtml(values[index].split(":").pop()) == value['full_name'][0]){

                        index++;
                        results.push([value['id'], value['name'], value['children']]);
                        search(value['children'], values);
                    }
                }
                
            });
            return results
        }

        /*Generates the select fields dinamically*/
        function generate_fields(values){

            for(var i=0; i < values.length; i++){
                var append_value = '<div class="form-group text-center"><select class="form-control" name="var" id="var"><option value="0">-- {% trans "Select Category" %} --</option>';
                children = values[i][2];

                if(!$.isEmptyObject(children))
                {
                    for(var j=0; j < children.length; j++){
                        if($.inArray("category:" + escapeHtml(children[j].full_name.toString()), params) >= 0)
                        {
                            append_value += '<option value="category:' + children[j].full_name + '" selected>' + children[j].name + '</option>';
                        }
                        else
                        {
                            append_value += '<option value="category:' + children[j].full_name + '">' + children[j].name + '</option>';
                        }
                    }
                    append_value += '</select></div>';
                    $('#search_field').before(append_value);
                }
            }
        }

        /*Instructions to catch the results*/    
        results = search(categories, params);
        if(results!=''){
            generate_fields(results);
        }


        /* Converts html text to plain text */
        function unescapeHtml(str){   
            var map = {amp: '&', lt: '<', le: '≤', gt: '>', ge: '≥', quot: '"', '#039': "'"} 
            return str.replace(/&([^;]+);/g, (m, c) => map[c]|| '') 
        }


        /* Converts plain text to html text */
        function escapeHtml(str){   
            var map = { '&': '&amp;', '<': '&lt;', '≤': '&le;', '>': '&gt;', '≥': '&ge;', '"': '&quot;', "'": '#039'};
            return str.replace(/([&<≤>≥'"]+)/g, (m, c) => map[c] || '');
        }


        /* When an category select widget is changed, its children must be cleared */
        $("select[name='var']").on('change', function(){

            $.each($(this).parent().nextUntil('#search_field'), function(key, elem){
                elem.remove();
            });

        });

    </script>
{% endblock extrascripts %}